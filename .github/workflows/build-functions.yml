name: Build Cloud Functions

on:
  push:
    paths:
      - 'functions/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Get functions list
        id: functions
        run: |
          functions=$(ls -d functions/*/ | cut -d'/' -f2 | tr '\n' ',' | sed 's/,$//')
          echo "list=$functions" >> $GITHUB_OUTPUT

      - name: Build Dart functions
        run: |
          for dir in functions/*/; do
            if [ -f "$dir/pubspec.yaml" ]; then
              echo "Building $(basename $dir)..."
              cd "$dir"
              dart pub get
              cd ../../
            fi
          done

      - name: Create function packages
        run: |
          mkdir -p build
          for dir in functions/*/; do
            fn_name=$(basename $dir)
            echo "Packaging $fn_name..."
            cd "$dir"
            zip -r "../../build/${fn_name}.zip" ./
            cd ../../
          done

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: appwrite-functions
          path: build/*.zip
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
